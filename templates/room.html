<!DOCTYPE html>
<html>
<head>
    <title>Room</title>
</head>
<body>
<h2>Room: {{ room_id }}</h2>

<ul id="chat"></ul>

<input id="msg" placeholder="Message">
<button type="button" onclick="send()">Send</button>


<script>
  const roomId = "{{ room_id }}";
  const username = "{{ username }}";
  const chat = document.getElementById("chat");

  function addLine(user, text) {
    const li = document.createElement("li");
    li.textContent = `${user}: ${text}`;
    chat.appendChild(li);
  }

  let ws = null;
  let reconnectTimer = null;

  function connectWS() {
    if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
      return;
    }

    ws = new WebSocket(
      `ws://localhost:8080/ws?room=${roomId}&username=${encodeURIComponent(username)}`
    );

    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      addLine(msg.user, msg.text);
    };

    ws.onclose = () => {
      if (reconnectTimer) return;
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connectWS();
      }, 1000);
    };
  }

  async function loadHistory() {
    chat.innerHTML = "";

    const res = await fetch(`/messages/${roomId}`);
    const list = await res.json();

    list.forEach(m => addLine(m.user, m.text));
  }

  loadHistory()
    .catch(err => console.log("history error:", err))
    .finally(() => {
      connectWS();
    });

  function send() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

    ws.send(text);
    input.value = "";
  }
  window.addEventListener("beforeunload", () => {
    if (ws) ws.close();
  });
</script>



</body>
</html>
